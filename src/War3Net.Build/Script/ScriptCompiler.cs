// ------------------------------------------------------------------------------
// <copyright file="ScriptCompiler.cs" company="Drake53">
// Licensed under the MIT license.
// See the LICENSE file in the project root for more information.
// </copyright>
// ------------------------------------------------------------------------------

using System;

namespace War3Net.Build.Script
{
    internal abstract class ScriptCompiler
    {
        private readonly ScriptCompilerOptions _options;

        protected ScriptCompiler(ScriptCompilerOptions options)
        {
            _options = options;
        }

        protected ScriptCompilerOptions Options => _options;

        public abstract void BuildAutogeneratedCode(out string globalsFilePath, out string mainFunctionFilePath, out string configFunctionFilePath);

        public abstract CompileResult Compile(out string scriptFilePath, params string[] additionalSourceFiles);

        // todo: not abstract? (since the implementation for jass and C# barely differs)
        public abstract void CompileSimple(out string scriptFilePath, params string[] additionalSourceFiles);

        [Obsolete("Script language should be obtained from MapInfo.ScriptLanguage property.", true)]
        public static ScriptCompiler GetUnknownLanguageCompiler(ScriptCompilerOptions options)
        {
            var sourceDirectory = options.SourceDirectory;

            var countJassFiles = 0;
            var countLuaFiles = 0;
            var countCSharpFiles = 0;

            var sourceDirectoryPathLength = sourceDirectory.Length + (sourceDirectory.EndsWith("\\") ? 0 : 1);
            foreach (var file in System.IO.Directory.EnumerateFiles(sourceDirectory, "*", System.IO.SearchOption.AllDirectories))
            {
                var relativePath = file.Substring(sourceDirectoryPathLength);

                if (relativePath.StartsWith(@"bin\") || relativePath.StartsWith(@"obj\"))
                {
                    continue;
                }

                switch (new System.IO.FileInfo(file).Extension.ToLower())
                {
                    case ".j": countJassFiles++; break;
                    case ".lua": countLuaFiles++; break;
                    case ".cs": countCSharpFiles++; break;

                    default: break;
                }
            }

            var countScriptLanguages =
                Math.Min(countJassFiles, 1) +
                Math.Min(countLuaFiles, 1) +
                Math.Min(countCSharpFiles, 1);

            if (countScriptLanguages == 1)
            {
                if (countJassFiles > 0) { return new JassScriptCompiler(options, null); }
                if (countCSharpFiles > 0) { return new CSharpScriptCompiler(options, null); }
                if (countLuaFiles > 0) { return new LuaScriptCompiler(options); }
            }

            return null;
        }
    }
}